import * as path from 'path'
import * as Recursive from '../Utils/Recursive'

export default class Translator {
    langsPath: string = '../../../app/langs/'
    langs: any = {}
    defaultLang: string

    /**
     * Initialize translations
     * @param defaultLang The default lang to use
     */
    constructor(defaultLang: string) {
        this.defaultLang = defaultLang
        this.langsPath = path.resolve(__dirname, this.langsPath)

        try {
            let file = path.resolve(this.langsPath, defaultLang + '.json')
            this.langs[defaultLang] = require(file)
        } catch (ex) {
            throw new Error('Unreachable language file (' + defaultLang + ')')
        }

        Recursive.loopFolders(path.resolve(this.langsPath, this.langsPath), (dir, langFile) => {
            let fullFile = path.join(dir, langFile)
            this.langs[langFile.split('.')[0]] = require(fullFile)
        })
    }

    getServerLang(serverid: string) {
        let lang = app.db.getConfig(serverid).get('lang').value()
        return (lang ? lang : this.defaultLang)
    }

    translate(path: string, lang: string = this.defaultLang, tags: { [key: string]: string } = {}): string {
        if (!lang || lang === 'default') lang = this.defaultLang

        try {
            let result = this.langs[lang], go = path.split('/')
            go.shift()

            go.forEach(function (value) {
                result = result[value]
            })
            for (var key in tags) {
                key = key.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&') // Regex escape
                result = result.replace(new RegExp('{' + key + '}', 'g'), tags[key])
            }
            return result
                .replace(new RegExp('{prefix}', 'g'), app.config.prefix)
                .replace(new RegExp('{botname}', 'g'), app.config.botname)
                .replace(new RegExp('{version}', 'g'), app.config.version)
                .replace(new RegExp('{lang}', 'g'), this.defaultLang)
                .replace(new RegExp('{invite_url}', 'g'), app.invite_url)

        } catch (ex) {
            throw new Error('Unable to access translation! Lang: ' + lang + ', Path: ' + path)
        }
    }
}
